@startuml C4_CICD_Linear_Flow

title CI/CD Pipeline - Linear Flow (Event Service & Ticket Service)

participant "Developer" as dev
participant "GitHub" as github
participant "GitHub Actions" as actions
database "Cache" as cache
participant "Test Runner" as test_runner
database "PostgreSQL\n(Ticket only)" as postgres
participant "Linter\n(Ticket only)" as linter
participant "Docker Builder" as builder
database "GHCR" as ghcr
participant "ArgoCD" as argocd
participant "Kubernetes" as k8s
participant "Codecov" as codecov

== Code Push ==

dev -> github: 1. git push main (HTTPS)
github -> actions: 2. Webhook trigger (Push event)

== Parallel Jobs Start ==

note right of actions
  Event Service: test → build
  Ticket Service: test + lint → build
end note

== Event Service: Test Job ==

actions -> test_runner: 3a. Checkout code
test_runner -> cache: 4a. Check Go modules cache
cache --> test_runner: 5a. Restore cached modules
test_runner -> test_runner: 6a. go test ./...\n- configs\n- controllers\n- middlewares\n- pkg/logger (100%)\n- pkg/metrics (100%)\n- pkg/utils (78.9%)
test_runner -> test_runner: 7a. Generate coverage\n20.5% total
test_runner -> codecov: 8a. Upload coverage.out
test_runner --> actions: 9a. ✅ Tests passed (Exit code 0)

== Ticket Service: Test Job (Parallel) ==

actions -> postgres: 3b. Start PostgreSQL container
postgres -> postgres: Health check: pg_isready
actions -> test_runner: 4b. Checkout code
test_runner -> cache: 5b. Check Go modules cache
test_runner -> test_runner: 6b. Prisma generate
test_runner -> postgres: 7b. Prisma db push\nCreate schema
test_runner -> test_runner: 8b. go test ./...\nwith DATABASE_URL
test_runner -> test_runner: 9b. Check threshold ≥ 15%
test_runner -> codecov: 10b. Upload coverage
test_runner --> actions: 11b. ✅ Tests passed

== Ticket Service: Lint Job (Parallel) ==

actions -> linter: 3c. Checkout code
linter -> linter: 4c. Prisma generate
linter -> linter: 5c. golangci-lint --timeout=5m
linter --> actions: 6c. ✅ Lint passed

== Event Service: Build & Push ==

note right of builder
  Needs: test job success
end note

actions -> builder: 10a. Checkout code
builder -> builder: 11a. docker buildx
builder -> ghcr: 12a. Login ghcr.io
builder -> builder: 13a. Build image\nFROM golang:1.23
builder -> ghcr: 14a. Push tags:\n- latest\n- {sha}
builder --> actions: 15a. ✅ Build complete

== Ticket Service: Build ==

note right of builder
  Needs: test + lint success
end note

actions -> builder: 12b. Checkout code
builder -> builder: 13b. Build API image
builder -> ghcr: 14b. Push API:\n- latest\n- {sha}
builder -> builder: 15b. Build Consumer image
builder -> ghcr: 16b. Push Consumer:\n- latest\n- {sha}
builder --> actions: 17b. ✅ Build complete

== Deployment ==

ghcr -> argocd: 16. Webhook:\nNew image available
argocd -> argocd: 17. Poll GitOps repo\nCheck for changes
argocd -> k8s: 18. kubectl apply\nRolling update
k8s -> ghcr: 19. Pull image (layer by layer)
k8s -> k8s: 20. Health check\n/livez, /readyz
k8s --> argocd: 21. Pods ready (Status: Running)

== Monitoring ==

note over codecov
  Coverage trend:
  Event: 20.5%
  Ticket: ~0.7%
end note

@enduml
